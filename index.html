<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Flappy Nerd</title>

    <script src="scripts/sprite.js" type="text/javascript"></script>
    <script src="scripts/nerd.js" type="text/javascript"></script>
    <script src="scripts/pipe.js" type="text/javascript"></script>
    <script src="scripts/helpers.js" type="text/javascript"></script>
    <script src="scripts/render.js" type="text/javascript"></script>

    <style>
        canvas {
            display: block;
            position: absolute;
            margin: auto;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>

<body>
    <script>
        document.addEventListener("DOMContentLoaded", function (event) {
            console.log("DOM fully loaded and parsed");
        });
        var
            canvas,
            ctx,
            width,
            height,
            okbtn,
            startbtn,

            updateId, //test

            fgpos = 0,
            frames = 0,
            score = 0,
            best = 0,
            gap = 110,

            previousDelta = 0, //test
            fpsLimit = 80, //test

            currentstate,
            states = {
                Splash: 0,
                Game: 1,
                Score: 2,
                FlappyNerd: 3
            }

        function main() {
            canvas = document.createElement("canvas");

            width = window.innerWidth;
            height = window.innerHeight;

            var evt = "touchstart";



            if (width >= 500) {
                width = width / 5;
                height = height / 1.5;
                canvas.style.border = "1px solid #000";
                evt = "mousedown";

            }

            document.addEventListener(evt, onpress);

            canvas.width = width;
            canvas.height = height;
            if (!(!!canvas.getContext && canvas.getContext("2d"))) {
                alert("Your browser doesn't support HTML5, please update to latest version");
            }
            ctx = canvas.getContext("2d");


            currentstate = states.FlappyNerd; //startstate

            document.body.appendChild(canvas);

            var img = new Image();
            img.onload = function () {
                initSprites(this);
                ctx.fillStyle = s_bg.color;

                okbtn = {
                    x: (width - s_buttons.Ok.width) / 2,
                    y: height - 200,
                    width: s_buttons.Ok.width,
                    height: s_buttons.Ok.height
                };

                startbtn = {
                    x: (width - s_buttons.Start.width) / 2,
                    y: height - 200,
                    width: s_buttons.Start.width,
                    height: s_buttons.Start.height
                };


                run();
            }
            img.src = "res/sheetx.png";

        }


        function run() {
            var loop = function (currentDelta) { //fps test,
                updateId = requestAnimationFrame(loop); //fps test
                var delta = currentDelta - previousDelta; //fps test
                if (fpsLimit && delta < 1000 / fpsLimit) {
                    return;
                } //fps test
                update();
                render();
                previousDelta = currentDelta; //fps test
            }
            window.requestAnimationFrame(loop, canvas);
        }


        function update() {
            frames++;

            if (currentstate !== states.Score) {
                fgpos = (fgpos - 2) % 14;

            } else {
                best = Math.max(best, score);
                localStorage.setItem("best", best);
            }

            if (currentstate === states.Game) {

                pipes.update();
            }
            nerd.update();


        }

        main();
    </script>
</body>

</html>